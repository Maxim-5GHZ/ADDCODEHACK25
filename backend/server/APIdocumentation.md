Отличная идея! Полная и понятная документация — ключ к эффективной работе с любым API.

Ниже представлена полная документация по API, сгенерированная на основе анализа предоставленных файлов. Она структурирована по функциональным блокам, с подробным описанием каждого эндпоинта, его параметров, а также примерами успешных и неуспешных ответов.

---

# Документация по API AgroAnalytics

## Общие сведения

- **Базовый URL:** Все эндпоинты API доступны по префиксу `/api`. Например: `https://your.domain/api/health`.
- **Формат данных:** Все запросы и ответы используют формат `JSON`.
- **Передача параметров:** Все параметры передаются как `Query` параметры в строке URL (например, `?token=...&login=...`).
- **Структура ответа:** Большинство ответов имеют следующую структуру:
  ```json
  {
      "status": "success" | "error" | "dismiss",
      // ... другие поля в зависимости от запроса
  }
  ```
  - `success`: Запрос успешно выполнен.
  - `error`: Произошла ошибка (неверные данные, внутренняя ошибка сервера). Поле `detail` будет содержать описание.
  - `dismiss`: Запрос выполнен, но данные не найдены. Поле `message` будет содержать пояснение.

---

## 1. Аутентификация и Управление Пользователями

### 1.1. Регистрация нового пользователя
- **Метод:** `POST`
- **Путь:** `/api/add_user`
- **Описание:** Создает нового пользователя в системе.

**Параметры (Query):**
- `login` (string, **обязательный**): Уникальный логин пользователя.
- `password` (string, **обязательный**): Пароль.
- `first_name` (string, **обязательный**): Имя пользователя.
- `last_name` (string, **обязательный**): Фамилия пользователя.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "message": "Пользователь успешно добавлен",
      "login": "newuser",
      "first_name": "Иван",
      "last_name": "Иванов"
  }
  ```
- **Ошибка (Пользователь существует):**
  ```json
  {
      "status": "error",
      "detail": "Пользователь с таким логином уже существует"
  }
  ```

### 1.2. Получение токена аутентификации
- **Метод:** `GET`
- **Путь:** `/api/get_token`
- **Описание:** Аутентифицирует пользователя и возвращает токен доступа.

**Параметры (Query):**
- `login` (string, **обязательный**): Логин пользователя.
- `password` (string, **обязательный**): Пароль.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "token": "123456789012345678901",
      "message": "Токен успешно получен"
  }
  ```
- **Ошибка (Неверный пароль):**
  ```json
  {
      "status": "error",
      "detail": "Неверный пароль"
  }
  ```
- **Ошибка (Пользователь не найден):**
  ```json
  {
      "status": "error",
      "detail": "Пользователь не найден"
  }
  ```

### 1.3. Получение профиля пользователя
- **Метод:** `GET`
- **Путь:** `/api/users/profile`
- **Описание:** Возвращает информацию о пользователе на основе его токена.

**Параметры (Query):**
- `token` (string, **обязательный**): Токен доступа пользователя.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "user": {
          "login": "testuser",
          "first_name": "Петр",
          "last_name": "Петров"
      }
  }
  ```
- **Ошибка (Неверный токен):**
  ```json
  {
      "status": "error",
      "detail": "Токен недействителен или пользователь не найден"
  }
  ```

---

## 2. Управление Сохраненными Полями

Этот блок эндпоинтов позволяет пользователям сохранять, просматривать и удалять свои сельскохозяйственные поля.

### 2.1. Сохранить поле
- **Метод:** `POST`
- **Путь:** `/api/fields/save`
- **Описание:** Сохраняет новое поле для пользователя с указанием его геометрии.

**Параметры (Query):**
- `token` (string, **обязательный**): Токен доступа пользователя.
- `field_name` (string, **обязательный**): Название поля (например, "Поле №3 у реки").
- `area_of_interest` (string, **обязательный**): JSON-строка, описывающая геометрию поля. Может быть точкой с радиусом или полигоном.
  - **Пример (точка с радиусом):** `'{"type": "point_radius", "lon": 37.5, "lat": 55.7, "radius_km": 0.5}'`
  - **Пример (полигон):** `'{"type": "polygon", "coordinates": [[37.1, 55.1], [37.2, 55.1], [37.2, 55.2], [37.1, 55.2], [37.1, 55.1]]}'`

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "message": "Поле успешно сохранено",
      "field": {
          "id": "1678886400",
          "name": "Поле №3 у реки",
          "area_of_interest": {
              "type": "point_radius",
              "lon": 37.5,
              "lat": 55.7,
              "radius_km": 0.5
          }
      }
  }
  ```
- **Ошибка (Неверный токен или формат JSON):**
  ```json
  {
      "status": "error",
      "detail": "Невалидный токен" // или "Неверный формат area_of_interest"
  }
  ```

### 2.2. Получить список полей
- **Метод:** `GET`
- **Путь:** `/api/fields/list`
- **Описание:** Возвращает список всех полей, сохраненных пользователем.

**Параметры (Query):**
- `token` (string, **обязательный**): Токен доступа.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "fields": [
          {
              "id": "1678886400",
              "name": "Поле №3 у реки",
              "area_of_interest": { /* ... */ }
          },
          {
              "id": "1678886300",
              "name": "Дальнее поле",
              "area_of_interest": { /* ... */ }
          }
      ]
  }
  ```

### 2.3. Удалить поле
- **Метод:** `DELETE`
- **Путь:** `/api/fields/{field_id}`
- **Описание:** Удаляет сохраненное поле по его ID.

**Параметры:**
- `field_id` (string, **path, обязательный**): ID поля, которое нужно удалить.
- `token` (string, **query, обязательный**): Токен доступа.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "message": "Поле успешно удалено"
  }
  ```
- **Ошибка (Поле не найдено):**
  ```json
  {
      "status": "error",
      "detail": "Поле с таким ID не найдено"
  }
  ```

---

## 3. Комплексный Анализ

Этот блок позволяет запускать полный анализ для указанной области за период, а также управлять результатами анализов.

### 3.1. Выполнить полный анализ
- **Метод:** `POST`
- **Путь:** `/api/analysis/perform`
- **Описание:** Запускает полный анализ по всем доступным вегетационным индексам (NDVI, SAVI, EVI, VARI) для указанной области и временного диапазона. Находит все безоблачные снимки, обрабатывает их и сохраняет результат.

**Параметры (Query):**
- `token` (string, **обязательный**): Токен доступа.
- `start_date` (string, **обязательный**): Начальная дата в формате `YYYY-MM-DD`.
- `end_date` (string, **обязательный**): Конечная дата в формате `YYYY-MM-DD`.
- `lon` (float, *опциональный*): Долгота центральной точки. Используется вместе с `lat` и `radius_km`.
- `lat` (float, *опциональный*): Широта центральной точки.
- `radius_km` (float, *опциональный*, по умолч. 0.5): Радиус в километрах от центральной точки.
- `polygon_coords` (string, *опциональный*): JSON-строка с координатами полигона. Пример: `'[[37.1, 55.1], [37.2, 55.1], [37.2, 55.2]]'`. **Примечание:** Если указан `polygon_coords`, параметры `lon`, `lat`, `radius_km` игнорируются.

**Ответы:**
- **Успех (200 OK):** Возвращает ID анализа и полные данные. Структура ответа очень большая.
  ```json
  {
    "status": "success",
    "analysis_id": "1678887000",
    "data": {
        "analysis_id": "1678887000",
        "timestamp": 1678887000.123,
        "area_of_interest": { /* ... */ },
        "date_range": { "start": "2023-05-01", "end": "2023-08-01" },
        "image_count": 3,
        "results_per_image": [
            {
                "date": "2023-05-15",
                "cloud_coverage": 0.01,
                "images": {
                    "rgb": "<base64_string>",
                    "ndvi": "<base64_string>",
                    "savi": "<base64_string>",
                    "vari": "<base64_string>",
                    "evi": "<base64_string>"
                },
                "ndvi_overlay_image": "<base64_png_string>",
                "problem_zones_image": "<base64_jpg_string>",
                "bounds": [[55.0, 37.0], [55.1, 37.1]],
                "statistics": {
                    "ndvi": {"min": 0.1, "max": 0.8, "mean": 0.65, "std": 0.1},
                    /* ... stats for savi, vari, evi ... */
                },
                "zoning": {
                    "ndvi": {"low": 5.2, "medium": 30.5, "high": 64.3}
                }
            },
            /* ... еще 2 объекта для других снимков ... */
        ],
        "metadata": { "source": "Sentinel-2" }
    }
  }
  ```
- **Ошибка (Нет снимков):**
  ```json
  {
      "status": "error",
      "detail": "Не найдено снимков за указанный период с облачностью менее 5.0%. Попробуйте расширить диапазон дат."
  }
  ```

### 3.2. Получить список анализов
- **Метод:** `GET`
- **Путь:** `/api/analysis/list`
- **Описание:** Возвращает краткую сводку по всем анализам пользователя.

**Параметры (Query):**
- `token` (string, **обязательный**): Токен доступа.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
    "status": "success",
    "analyses": [
        {
            "analysis_id": "1678887000",
            "timestamp": 1678887000.123,
            "area_of_interest": { /* ... */ },
            "date_range": { "start": "2023-05-01", "end": "2023-08-01" },
            "image_count": 3,
            "statistics_summary": {
                "ndvi_mean": 0.68,
                "vari_mean": 0.15,
                "evi_mean": 0.55
            }
        },
        /* ... другие анализы ... */
    ]
  }
  ```

### 3.3. Получить данные конкретного анализа
- **Метод:** `GET`
- **Путь:** `/api/analysis/{analysis_id}`
- **Описание:** Возвращает полные данные анализа по его ID.

**Параметры:**
- `analysis_id` (string, **path, обязательный**): ID анализа.
- `token` (string, **query, обязательный**): Токен доступа.

**Ответы:**
- **Успех (200 OK):** Структура ответа идентична успешному ответу от `POST /api/analysis/perform`.
- **Ошибка (Анализ не найден):**
  ```json
  {
      "status": "error",
      "detail": "Анализ не найден"
  }
  ```

### 3.4. Удалить анализ
- **Метод:** `DELETE`
- **Путь:** `/api/analysis/{analysis_id}`
- **Описание:** Удаляет анализ по его ID.

**Параметры:**
- `analysis_id` (string, **path, обязательный**): ID анализа.
- `token` (string, **query, обязательный**): Токен доступа.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "message": "Анализ успешно удален"
  }
  ```

---

## 4. AI Рекомендации и Исторические Данные

### 4.1. Получить AI рекомендации
- **Метод:** `GET`
- **Путь:** `/api/analysis/{analysis_id}/recommendations`
- **Описание:** На основе данных анализа (средних значений всех индексов) генерирует агрономические рекомендации с помощью GigaChat.

**Параметры:**
- `analysis_id` (string, **path, обязательный**): ID анализа.
- `token` (string, **query, обязательный**): Токен доступа.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
    "status": "success",
    "recommendation": "### Комплексный анализ состояния посевов\n\nОбщая оценка: Состояние растительности в целом хорошее, о чем свидетельствуют высокие средние значения NDVI и EVI. ... \n\n### Рекомендации:\n\n1.  **Точечная проверка:** ...\n2.  **Оптимизация полива:** ...\n3.  **Контроль питательных веществ:** ...",
    "average_indices": {
        "ndvi": 0.712,
        "savi": 0.655,
        "evi": 0.589,
        "vari": 0.183
    }
  }
  ```
- **Ошибка (Нет данных для анализа):**
  ```json
  {
      "status": "error",
      "detail": "В данных анализа отсутствуют статистики для расчета средних значений индексов."
  }
  ```

### 4.2. Получить исторические данные NDVI
- **Метод:** `GET`
- **Путь:** `/api/analysis/timeseries`
- **Описание:** Возвращает временной ряд среднемесячных значений NDVI для указанной области за последние 2 года.

**Параметры (Query):**
- `token` (string, **обязательный**): Токен доступа.
- `lon`, `lat`, `radius_km` или `polygon_coords`: Аналогично `POST /api/analysis/perform`.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
    "status": "success",
    "data": [
        { "date": "2022-05-01", "mean_ndvi": 0.45 },
        { "date": "2022-06-01", "mean_ndvi": 0.72 },
        { "date": "2022-07-01", "mean_ndvi": 0.78 },
        // ...
        { "date": "2023-05-01", "mean_ndvi": 0.51 },
        { "date": "2023-06-01", "mean_ndvi": 0.75 }
    ]
  }
  ```
- **Ошибка (Не указана область):**
  ```json
  {
      "status": "error",
      "detail": "Необходимо указать область"
  }
  ```

---

## 5. Получение Одиночных Изображений

Эти эндпоинты предназначены для быстрой визуализации и получения данных по самому чистому снимку за период.

### 5.1. Получить RGB изображение
- **Метод:** `GET`
- **Путь:** `/api/image/rgb`
- **Описание:** Загружает и возвращает RGB-изображение для указанной области.

**Параметры (Query):**
- `lon`, `lat`, `start_date`, `end_date`, `token` (все **обязательные**).

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "image_type": "rgb",
      "image_data": "<base64_jpeg_string>",
      "format": "jpeg",
      "coordinates": { "lon": 37.5, "lat": 55.7 },
      "date_range": { "start": "2023-07-01", "end": "2023-07-31" }
  }
  ```

### 5.2. Получить изображение красного канала (Red)
- **Метод:** `GET`
- **Путь:** `/api/image/red-channel`
- **Описание:** Аналогично, но возвращает изображение красного канала (в градациях серого) и его статистику.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "image_type": "red_channel",
      "image_data": "<base64_jpeg_string>",
      "format": "jpeg",
      "statistics": {
          "min_value": 120.0,
          "max_value": 2150.0,
          "mean_value": 850.5
      },
      // ... другие поля
  }
  ```

### 5.3. Получить изображение NDVI
- **Метод:** `GET`
- **Путь:** `/api/image/ndvi`
- **Описание:** Вычисляет и возвращает карту NDVI (в градациях серого) и статистику.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "image_type": "ndvi",
      "image_data": "<base64_jpeg_string>",
      "format": "jpeg",
      "statistics": {
          "min_ndvi": -0.1,
          "max_ndvi": 0.85,
          "mean_ndvi": 0.67
      },
      // ... другие поля
  }
  ```

---

## 6. Сервер и Администрирование

### 6.1. Проверка состояния сервера
- **Метод:** `GET`
- **Путь:** `/api/health`
- **Описание:** Простой эндпоинт для проверки, что сервер запущен и отвечает.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "healthy",
      "message": "Server is running",
      "timestamp": 1678888000.123
  }
  ```

### 6.2. Получить лог-файл (для администратора)
- **Метод:** `GET`
- **Путь:** `/api/log`

**Параметры (Query):**
- `password` (string, **обязательный**): Пароль администратора.

**Ответы:**
- **Успех (200 OK):** Возвращает содержимое файла `app.log`.
- **Ошибка (Доступ запрещен):**
  ```json
  {
      "status": "error",
      "detail": "Доступ запрещен"
  }
  ```

### 6.3. Получить список всех пользователей (для администратора)
- **Метод:** `GET`
- **Путь:** `/api/users/all`

**Параметры (Query):**
- `password` (string, **обязательный**): Пароль администратора.

**Ответы:**
- **Успех (200 OK):**
  ```json
  {
      "status": "success",
      "users": [
          { "login": "admin", "first_name": "Admin", "last_name": "User" },
          { "login": "testuser", "first_name": "Петр", "last_name": "Петров" }
      ]
  }
  ```
